<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Project Gantt</title>
    <meta property="og:url" content="https://ricwtk.github.io/project-gantt">
    <meta property="og:title" content="Project Gantt">
    <meta property="og:description" content="Gantt chart editor">
    <meta name="description" content="Gantt chart editor">
    <meta name="keywords" content="Project Gantt, Gantt chart, editor">
    <link rel="icon" type="image/png" href="icons/icon.png?v=1.0">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="//cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="//cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <style>
      [v-cloak] { display:none; }
      .file-dialog { height: 90%; }
    </style>
  </head>

  <body>
    <div id="app" v-cloak>
      <v-app>
        <v-navigation-drawer
          v-model="drawer"
          app
          clipped
          mobile-break-point="1000"
        >
          <v-list subheader>
            <v-list-group>
              <template v-slot:activator>
                <v-list-item-avatar left><v-icon>mdi-account</v-icon></v-list-item-avatar>
                <v-list-item-content><v-list-item-title>Import/Export JSON</v-list-item-title></v-list-item-content>
              </template>
            </v-list-group>
        
            <v-divider></v-divider>

            <!-- Gantt Chart List -->
            <v-list-item v-for="(gantt, i) in gantts" :key="'nav-gantt-' + i" link @click="scrollToGantt(i)">
              <v-list-item-action><v-icon>mdi-chart-gantt</v-icon></v-list-item-action>
              <v-list-item-content>
                <v-list-item-title>{{ gantt.ganttChartName || ('Gantt Chart ' + (i+1)) }}</v-list-item-title>
              </v-list-item-content>
            </v-list-item>

            <v-divider></v-divider>

            <v-list-item link @click="openPrivacyPolicy">
              <v-list-item-action><v-icon>mdi-security</v-icon></v-list-item-action>
              <v-list-item-content><v-list-item-title>Privacy policy</v-list-item-title></v-list-item-content>
            </v-list-item>
            <v-list-item link @click="helpDialog = true">
              <v-list-item-action><v-icon>mdi-help-circle</v-icon></v-list-item-action>
              <v-list-item-content><v-list-item-title>Help</v-list-item-title></v-list-item-content>
            </v-list-item>

            <v-divider></v-divider>

            <v-list-item link @click="newInOld">
              <v-list-item-action><v-icon>mdi-file-plus</v-icon></v-list-item-action>
              <v-list-item-content><v-list-item-title>New</v-list-item-title></v-list-item-content>
              <v-list-item-action @click.stop="newInNew"><v-icon>mdi-open-in-new</v-icon></v-list-item-action>
            </v-list-item>
            <v-list-item link @click="importJSON">
              <v-list-item-action><v-icon>mdi-file-import</v-icon></v-list-item-action>
              <v-list-item-content><v-list-item-title>Import JSON</v-list-item-title></v-list-item-content>
            </v-list-item>
            <v-list-item link @click="exportJSON">
              <v-list-item-action><v-icon>mdi-file-export</v-icon></v-list-item-action>
              <v-list-item-content><v-list-item-title>Export JSON</v-list-item-title></v-list-item-content>
            </v-list-item>
            
          </v-list>
        </v-navigation-drawer>

        <v-app-bar app dark dense clipped-left color="primary">
          <v-app-bar-nav-icon @click.stop="drawer = !drawer"></v-app-bar-nav-icon>
          <v-avatar tile height="75%" aspect-ratio="1"><v-img src="icons/icon.png" contain></v-img></v-avatar>
          <v-toolbar-title class="pr-1">Project Gantt</v-toolbar-title>
          <v-spacer></v-spacer>
        </v-app-bar>
        <v-content>
          <v-container>
            
            <v-row no-gutters class="title" align="end">
              <v-col>{{ currentFile.name ? fileNameForDisplay : "Unsaved file" }}</v-col>
              <v-col cols="auto" class="subtitle-2" v-if="currentFile.name.endsWith('.pgjson')">.pgjson</v-col>
            </v-row>
            
            <gantt-chart v-for="gc,i in gantts" ref="gc" :key="i" :id="'gc' + i"
              v-model="gantts[i]"
              @reorder-task="reorderTask($event,i)"
              @remove="removeGantt(i)"
            ></gantt-chart>

            <v-row no-gutters>
              <v-col><v-btn tile block depressed style="background-color: white; border: 1px solid #ddd" title="new Gantt chart" @click="addNewGantt"><v-icon>mdi-plus</v-icon></v-btn></v-col>
            </v-row>

          </v-container>
        </v-content>

        <help-dialog v-model="helpDialog"></help-dialog>

        <v-overlay :value="blockingLoading" z-index="999" class="text-center">
          <v-icon class="display-4">mdi-loading mdi-spin</v-icon>
          <v-row justify="center" align="center">
            <v-col cols="auto" class="display-2 font-weight-black">
              {{ blockingLoadingText }}
            </v-col>
          </v-row>
        </v-overlay>

        <v-snackbar v-model="showNotice" top>
          <v-row no-gutters justify="center">
            <v-col cols="auto">{{ notice }}</v-col>
          </v-row>
        </v-snackbar>

        <v-footer>
          <v-col class="text-center" cols=12>
            Powered by <span style="cursor:pointer" @click="openSite('//vuejs.org/')">Vue</span> and <span style="cursor:pointer" @click="openSite('//vuetifyjs.com/')">Vuetify</span>, created by <span style="cursor:pointer" @click="openSite('//ricwtk.github.io')">R.ich.ard</span>
          </v-col>
        </v-footer>

        <v-dialog v-model="exportReminderDialog" persistent max-width="400px">
          <v-card>
            <v-card-title class="headline">Reminder</v-card-title>
            <v-card-text>
              You have unsaved changes. Please export your data before leaving!
            </v-card-text>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn color="primary" @click="handleExportReminder('export')" depressed>Export Now</v-btn>
              <v-btn color="secondary" @click="handleExportReminder('leave')" depressed>Leave Anyway</v-btn>
              <v-btn color="grey darken-2" dark @click="handleExportReminder('cancel')" depressed>Cancel</v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-app>
    </div>

    <template id="gantt-chart-list-item">
      <v-list-item link @click="$emit('click', $event)" draggable :class="additionalClass">
        <v-list-item-action><v-icon>mdi-chart-gantt</v-icon></v-list-item-action>
        <v-list-item-content><v-list-item-title>{{ itemName }}</v-list-item-title></v-list-item-content>
      </v-list-item>
    </template>

    <template id="gantt-chart">
      <v-container>
        <v-row no-gutters class="pt-3 pb-2" align="end">
          <v-col class="title">{{ settings.ganttChartName }}</v-col>
          <v-col cols="auto">
            <v-row no-gutters>
              <v-col><v-btn icon title="toggle edit mode" @click="settings.editMode = !settings.editMode"><v-icon>mdi-pencil</v-icon></v-btn></v-col>
              <v-col><v-btn icon title="decrease row height" @click="reduceRowHeight"><v-icon>mdi-arrow-collapse-vertical</v-icon></v-btn></v-col>
              <v-col><v-btn icon title="increase row height" @click="increaseRowHeight"><v-icon>mdi-arrow-expand-vertical</v-icon></v-btn></v-col>
              <v-col><v-btn icon title="decrease column width" @click="reduceColWidth"><v-icon>mdi-arrow-collapse-horizontal</v-icon></v-btn></v-col>
              <v-col><v-btn icon title="increase column width" @click="increaseColWidth"><v-icon>mdi-arrow-expand-horizontal</v-icon></v-btn></v-col>
            </v-row>
          </v-col>
          <v-col cols="auto"><gantt-settings v-model="settings" @input="emitInput" @remove="$emit('remove')"></gantt-settings></v-col>
        </v-row>

        <v-row no-gutters>
          <v-col cols="3">
            <v-row no-gutters class="flex-nowrap">
              <v-col cols="auto">
                <v-row no-gutters style="border: 1px solid #ddd; background-color: white" :style="{ height: (40 * (settings.dateDisplay.length + 1)) + 'px' }" justify="center" align="center">
                  <v-col cols="auto" class="pa-2 text-no-wrap text-truncate">
                    ID
                  </v-col>
                </v-row>
                <v-row no-gutters>
                  <v-col cols="0" :style="{ height: (settings.rowHeight * taskToDisplay.length) + 'px' }" class="d-flex flex-column">
                    <v-row no-gutters v-for="taskId,n in taskToDisplay" :key="n" style="border: 1px solid #ddd; border-top: 0px; background-color: white" justify="center" align="center">
                      <v-col cols="auto" class="text-no-wrap text-truncate">
                        {{ getTaskId(taskId) }}
                      </v-col>
                    </v-row>
                  </v-col>
                </v-row>
              </v-col>
              <v-col cols="0">
                <v-row no-gutters style="border: 1px solid #ddd; border-left: 0px; background-color: white" :style="{ height: (40 * (settings.dateDisplay.length + 1)) + 'px' }" justify="center" align="center">
                  <v-col cols="auto" class="text-no-wrap text-truncate">Task</v-col>
                </v-row>
                <v-row no-gutters>
                  <v-col cols="0" :style="{ height: (settings.rowHeight * taskToDisplay.length) + 'px' }" class="d-flex flex-column">
                    <task-title no-gutters v-for="taskId,i in taskToDisplay" :key="i" 
                      style="border: 1px solid #ddd; border-left: 0px; border-top: 0px; background-color: white"
                      :edit-mode="settings.editMode"
                      :value="getTaskFromId(taskId)"
                      @input="setTaskFromId(taskId,$event)"
                      @remove="removeTaskWithId(taskId)"
                      @dragstart="startDragTask($event,taskId)"
                      @drop="dropTask($event,taskId)"
                    >
                    </task-title>
                  </v-col>
                </v-row>
              </v-col>
            </v-row>
            <v-row no-gutters>
              <v-btn v-if="settings.editMode" depressed tile block 
                height="40px" 
                style="border: 1px solid #ddd; border-top: 0px; background-color: white"
                @click="addNewTask"
              ><v-icon>mdi-plus</v-icon></v-btn>
            </v-row>
          </v-col>

          <v-col style="overflow: auto;">
            <v-row no-gutters style="height: 40px; border: 1px solid #ddd; border-left: 0px; background-color: white" justify="center" align="center" :style="{ width: (settings.columnWidth * numberOfColumn) + 'px', 'max-width': '100%' }">
              <v-col cols="auto" class="text-no-wrap text-truncate">
                Date
              </v-col>
            </v-row>
            <v-row no-gutters>
              <v-col style="overflow: auto;">
                <v-row no-gutters class="flex-nowrap" style="height: 40px;" v-for="cl,i in colLabels" v-if="settings.dateDisplay.includes(i)" :style="{ width: (settings.columnWidth * numberOfColumn) + 'px'}" :key="i">
                  <v-col cols="auto" class="d-flex" v-for="c,j in cl" :key="j" style="border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; background-color: white; min-width: 0;"  :style="{ width: (settings.columnWidth * c.count) + 'px'  }">
                    <v-row no-gutters justify="center" align="center" style="max-width: 100%" :title="c.value">
                      <v-col cols="auto" class="text-no-wrap text-truncate" style="min-width: 0;">{{ c.value }}</v-col>
                    </v-row>
                  </v-col>
                </v-row>
                <v-row no-gutters :style="{ width: (settings.columnWidth * numberOfColumn) + 'px' }">
                  <v-col cols="0" :style="{ height: (settings.rowHeight * taskToDisplay.length) + 'px' }" class="d-flex flex-column">
                    <v-row no-gutters class="flex-nowrap" style="position: relative;" v-for="taskId,m in taskToDisplay" :key="m">
                      <v-col cols="0" class="d-flex" v-for="cl,i in numberOfColumn" :key="i" style="border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; background-color: white">
                        <v-row no-gutters justify="center" align="center">
                          <v-col cols="auto"></v-col>
                        </v-row>
                      </v-col>
                      <!-- Planned bar -->
                      <v-card class="d-flex align-self-center" outlined tile height="80%" :min-width="getBarWidth(taskId, 'planned') + 'px'" style="position:absolute;" :style="{left: getDatePos(taskId, 'planned')+'px', 'background-color': colorList[(taskId[taskId.length-1])%colorList.length], opacity: 0.7}"></v-card>
                      <!-- Actual bar -->
                      <v-card v-if="getBarWidth(taskId, 'actual') > 0" class="d-flex align-self-center" outlined tile height="40%" :min-width="getBarWidth(taskId, 'actual') + 'px'" style="position:absolute;" :style="{left: getDatePos(taskId, 'actual')+'px', 'background-color': '#607D8B', opacity: 0.9, top: '40%'}"></v-card>
                    </v-row>    
                  </v-col>
                </v-row>
              </v-col>
            </v-row>
          </v-col>
        </v-row>
      </v-container>
    </template>

    <template id="gantt-settings">
      <v-btn icon title="settings" @click="isOpened = !isOpened; updateValue()">
        <v-icon>mdi-settings</v-icon>
        <v-dialog v-model="isOpened" max-width="1000px">
          <v-card>
            <v-card-title>Settings</v-card-title>
            <v-card-text>
              <v-row no-gutters><v-col><v-text-field hide-details v-model="ganttChartName" label="Gantt chart name"></v-text-field></v-col></v-row>
              <v-row no-gutters justify="center" align="center" class="mt-1">
                <v-col class="font-weight-black">Edit mode</v-col>
                <v-col cols="auto"><v-switch inset v-model="editMode"></v-switch></v-col>
              </v-row>
              <v-row no-gutters justify="center" align="center" class="mt-1">
                <v-col class="font-weight-black">Date display</v-col>
                <v-col cols="auto"><v-btn-toggle v-model="dateDisplay" multiple><v-btn v-for="d in ['year', 'month', 'day']" :key="d">{{ d }}</v-btn></v-btn-toggle></v-col>
              </v-row>
              <v-row no-gutters><v-col><v-text-field type="number" hide-details label="Date column width" min="1" suffix="px" prepend-icon="mdi-arrow-expand-horizontal" v-model="columnWidth" class="pb-2"></v-text-field></v-col></v-row>
              <v-row no-gutters><v-col><v-text-field type="number" hide-details label="Row height" min="1" suffix="px" prepend-icon="mdi-arrow-expand-vertical" v-model="rowHeight" class="pb-2"></v-text-field></v-col></v-row>
              <v-row no-gutters><v-col class="font-weight-black pt-2">Color Scheme</v-col></v-row>
              <v-row no-gutters><v-col><v-select hide-details v-model="numberOfClass" :items="[3,4,5,6,7,8,9,'custom']" label="Number of classes" class="pb-2"></v-select></v-col></v-row>
              <v-row no-gutters class="flex-nowrap" style="overflow:auto" v-if="numberOfClass!='custom'">
                <v-col v-for="cs in Object.keys(colorbrewer)" :key="cs">
                  <v-card tile outlined 
                    class="ma-1" 
                    width="50px" max-width="50px" 
                    :title="cs" 
                    v-if="colorbrewer[cs][numberOfClass]" 
                    :style="{ 'background-color': cs==selectedScheme ? '#607D8B' : '#ECEFF1' }"
                    @click="selectedScheme=cs">
                    <v-card-text>
                      <v-row v-for="color in colorbrewer[cs][numberOfClass]" :key="cs+color" justify="center">
                        <v-col cols="10" :style="{ 'background-color': color }"></v-col>
                      </v-row>
                    </v-card-text>
                  </v-card>
              </v-row>
              <v-row no-gutters v-else>
                <v-col cols="12">
                  <v-col cols="12">
                    <v-row no-gutters>
                      <v-col cols="auto" v-for="cs,i in customScheme" :key="i" class="ma-1 pa-1">
                        <v-card flat height="30px" width="50px" 
                          :style="{ 'background-color': cs.color }" 
                          :title="cs.color"
                        ></v-card>
                      </v-col>
                    </v-row>
                  </v-col>
                  <v-expansion-panels v-model="customPanel">
                    <template v-for="cs,i in customScheme">
                      <v-col cols="12" :key="i">
                        <v-btn min-width="100%" @click="addNewColor(i)">Add <v-icon>mdi-playlist-plus</v-icon></v-btn>
                      </v-col>
                      <v-expansion-panel>
                        <v-expansion-panel-header>
                          <v-row no-gutters align="center">
                            <v-col cols="auto"><v-btn icon @click.stop="customScheme.splice(i,1)"><v-icon>mdi-minus</v-icon></v-btn></v-col>
                            <v-col cols="auto" class="pr-1">{{ i+1 }}</v-col>
                            <v-col>
                              <v-row no-gutters justify="center" align="center">
                                <v-col cols="8"><v-card flat height="30px" :style="{ 'background-color': cs.color }"></v-card></v-col>
                              </v-row>
                            </v-col>
                          </v-row>
                        </v-expansion-panel-header>
                        <v-expansion-panel-content><color-chooser v-model="customScheme[i]" @selected="customPanel = null"></color-chooser></v-expansion-panel-content>
                      </v-expansion-panel>
                    </template>
                    <v-col cols="12" class="mt-2">
                      <v-btn min-width="100%" @click="addNewColor()">Add <v-icon>mdi-playlist-plus</v-icon></v-btn>
                    </v-col>
                  </v-expansion-panels>
                </v-col>
              </v-row>
            </v-card-text>
            <v-card-actions>
              <v-btn text @click="isOpened = !isOpened; $emit('remove');">Delete</v-btn>
              <v-spacer></v-spacer>
              <v-btn text @click="isOpened = !isOpened; confirmSettings();">Ok</v-btn>
              <v-btn text @click="isOpened = !isOpened">Cancel</v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-btn>
    </template>
    
    <template id="color-chooser">
      <v-card>
        <v-card-text>
          <v-row>
            <v-tabs grow v-model="customColorTab">
              <v-tab>Palette</v-tab>
              <v-tab>Scheme</v-tab>
            </v-tabs>
            <v-tabs-items v-model="customColorTab" style="width:100%">
              <v-tab-item>
                <v-card flat>
                  <v-card-text>
                    <v-row no-gutters>
                      <v-col>
                        <v-slider v-model="minVal" prepend-icon="mdi-palette" min="0" max="200" :label="minVal.toString()" inverse-label></v-slider>
                      </v-col>
                    </v-row>
                    <v-row no-gutters>
                      <v-col>
                        <v-slider v-model="totalChoice" prepend-icon="mdi-music-accidental-sharp" min="6" step="6" max="300" :label="totalChoice.toString()" inverse-label></v-text-field>
                      </v-col>
                    </v-row>
                    <v-row no-gutters>
                      <v-col cols="auto" v-for="cp,i in colorPalette" :key="i" class="ma-1 pa-1" 
                        :style="{ border: '1px solid', 'border-color': cp == value.color ? '#333' : '#fff'}">
                        <v-card hover flat height="30px" width="50px" 
                          :style="{ 'background-color': cp }" 
                          :title="cp"
                          @click="selectColor(cp)"
                        ></v-card>
                      </v-col>
                    </v-row>
                    <v-row no-gutters>
                      <v-col cols="auto" v-for="gp,i in greyPalette" :key="i" class="ma-1 pa-1" 
                        :style="{ border: '1px solid', 'border-color': gp == value.color ? '#333' : '#fff'}">
                        <v-card hover flat height="30px" width="50px" 
                          :style="{ 'background-color': gp }" 
                          :title="gp"
                          @click="selectColor(gp)"
                        ></v-card>
                      </v-col>
                    </v-row>
                  </v-card-text>
                </v-card>
              </v-tab-item>
              <v-tab-item>
                <v-card flat>
                  <v-card-text>
                    <v-row no-gutters justify="center">
                      <v-col cols="auto">
                        <v-row no-gutters v-for="cs in Object.keys(colorbrewer)" :key="cs" v-if="colorbrewer[cs][9]">
                          <v-col cols="auto" v-for="color in colorbrewer[cs][9]" :key="color" class="ma-1 pa-1" 
                            :style="{ border: '1px solid', 'border-color': color == value.color ? '#333' : '#fff'}">
                            <v-card hover flat height="30px" width="50px" 
                              :style="{ 'background-color': color }" 
                              :title="color"
                              @click="selectColor(color)"
                            ></v-card>
                          </v-col>
                        </v-row>
                      </v-col>
                    </v-row>
                  </v-card-text>
                </v-card>  
              </v-tab-item>
            </v-tabs-items>
          </v-row>
        </v-card-text>
      </v-card>
    </template>

    <template id="task-title">
      <v-row no-gutters justify="start" align="center" @click="openDetails" style="cursor: pointer" draggable :class="additionalClass">
        <v-col>
          <v-row no-gutters align="center" class="flex-nowrap">
            <v-col cols="auto" v-if="editMode" class="pl-1"><v-icon>mdi-cursor-move</v-icon></v-col>
            <v-col cols="0" class="pl-1 pr-1 text-no-wrap text-truncate" :title="value.description">
              <slot v-bind:value="value"><v-icon v-if="value.subtasks.length>0" @click.stop="value.collapsed = !value.collapsed">{{ value.collapsed ? 'mdi-chevron-right' : 'mdi-chevron-down' }}</v-icon>{{ value.name }}</slot>
            </v-col>
            <v-col cols="auto"><v-btn icon small v-if="editMode" @click.stop="$emit('remove')"><v-icon>mdi-minus</v-icon></v-col>
          </v-row>
          <v-dialog v-model="isOpened" max-width="1000px">
            <v-card>
              <v-card-title>Task details</v-card-title>
              <v-card-text>
                <v-row no-gutters class="mb-4"><v-col><v-text-field hide-details v-model="details.name" label="Task name"></v-text-field></v-col></v-row>
                <v-row no-gutters class="mb-4"><v-col><v-textarea outlined hide-details v-model="details.description" label="Task description"></v-textarea></v-col></v-row>
                <v-row no-gutters class="mb-4">
                  <v-col>
                    <v-row no-gutters align="center">
                      <v-col>
                        <v-menu
                          ref="planned"
                          v-model="plannedMenu"
                          :close-on-content-click="false"
                          :return-value.sync="details.planned"
                          transition="scale-transition"
                          offset-y
                          min-width="290px"
                        >
                          <template v-slot:activator="{ on }">
                            <v-text-field
                              hide-details
                              prepend-icon="mdi-calendar"
                              v-model="plannedText"
                              label="Planned date"
                              readonly
                              v-on="on"
                            ></v-text-field>
                          </template>
                          <v-date-picker v-model="details.planned" range no-title scrollable>
                            <v-spacer></v-spacer>
                            <v-btn text @click="$refs.planned.save(details.planned)">OK</v-btn>
                            <v-btn text @click="plannedMenu = false">Cancel</v-btn>
                          </v-date-picker>
                        </v-menu>
                      </v-col>
                      <v-col cols="auto">
                        <v-btn x-small text color="red" class="ml-2" @click="details.planned = ['', '']">Clear</v-btn>
                      </v-col>
                    </v-row>
                  </v-col>
                </v-row>
                <v-row no-gutters class="mb-4">
                  <v-col>
                    <v-row no-gutters align="center">
                      <v-col>
                        <v-menu
                          ref="actual"
                          v-model="actualMenu"
                          :close-on-content-click="false"
                          :return-value.sync="details.actual"
                          transition="scale-transition"
                          offset-y
                          min-width="290px"
                        >
                          <template v-slot:activator="{ on }">
                            <v-text-field
                              hide-details
                              prepend-icon="mdi-calendar"
                              v-model="actualText"
                              label="Actual date"
                              readonly
                              v-on="on"
                            ></v-text-field>
                          </template>
                          <v-date-picker v-model="details.actual" range no-title scrollable>
                            <v-spacer></v-spacer>
                            <v-btn text @click="$refs.actual.save(details.actual)">OK</v-btn>
                            <v-btn text @click="actualMenu = false">Cancel</v-btn>
                          </v-date-picker>
                        </v-menu>
                      </v-col>
                      <v-col cols="auto">
                        <v-btn x-small text color="red" class="ml-2" @click="details.actual = ['', '']">Clear</v-btn>
                      </v-col>
                    </v-row>
                  </v-col>
                </v-row>
                <v-row no-gutters><v-col class="font-weight-black">Subtasks</v-col></v-row>
                <task-title no-gutters v-for="task,i in details.subtasks" :key="i" class="pa-3"
                  :style="i == details.subtasks.length - 1 ? 'background-color: white' : 'border-bottom: 1px solid #ddd; background-color: white'"
                  :edit-mode="true"
                  v-model="details.subtasks[i]"
                  @remove="removeSubtask(i)"
                  v-slot:default="props"
                  @dragstart="startDragSubTask($event,i)"
                  @drop="dropSubTask($event,i)"
                >
                  <v-row no-gutters>
                    <v-col cols="6" class="text-no-wrap text-truncate" :title="props.value.name">{{ props.value.name }}</v-col>
                    <v-col cols="3" class="text-no-wrap text-truncate" :title="'planned: ' + props.value.planned[0] + ' ~ ' + props.value.planned[1]" class="text-center">{{ props.value.planned[0] + ' ~ ' + props.value.planned[1] }}</v-col>
                    <v-col cols="3" class="text-no-wrap text-truncate" :title="'actual: ' + props.value.actual[0] + ' ~ ' + props.value.actual[1]" class="text-center">{{ props.value.actual[0] + ' ~ ' + props.value.actual[1] }}</v-col>
                  </v-row>
                </task-title>
                <v-btn depressed tile block @click="addNewSubtask"><v-icon>mdi-plus</v-icon></v-btn>
              </v-card-text>
              <v-card-actions>
                <v-btn text @click="isOpened = !isOpened; $emit('remove')">Delete</v-btn>
                <v-spacer></v-spacer>
                <v-btn text @click="isOpened = !isOpened; confirmChanges();">Ok</v-btn>
                <v-btn text @click="isOpened = !isOpened">Cancel</v-btn>
              </v-card-actions>
            </v-card>
          </v-dialog>
        </v-col>
      </v-row>
    </template>

    <template id="help-dialog">
      <v-dialog :value="value" @input="changeValue" content-class="help-dialog" scrollable>
        <v-card>
          <v-card-title><v-icon>mdi-help-circle</v-icon>&nbsp;Help</v-card-title>
          <v-divider></v-divider>
          <v-card-text class="pt-5">
            <v-expansion-panels>
              <v-expansion-panel v-for="c,i in content" :key="i">
                <v-expansion-panel-header v-html="c.title"></v-expansion-panel-header>
                <v-expansion-panel-content>{{ c.content }}</v-expansion-panel-content>
              </v-expansion-panel>
            </v-expansion-panels>
          </v-card-text>
          <v-divider></v-divider>
          <v-card-actions>
            <v-spacer></v-spacer><v-btn color="primary" depressed @click.stop="closeDialog">Close</v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
    </template>

    <script src="./colorbrewer.js"></script>
    <script src="//cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="//cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
      let oneday = 1000*60*60*24;
      let startDay = new Date();
      startDay = startDay.getFullYear() + '-' + (startDay.getMonth()+1).toString().padStart(2,'0') + '-' + startDay.getDate().toString().padStart(2,'0');
      let endDay = new Date(Date.now() + 30*oneday); 
      endDay = endDay.getFullYear() + '-' + (endDay.getMonth()+1).toString().padStart(2,'0') + '-' + endDay.getDate().toString().padStart(2,'0');

      // Function to get and set Gantt data in localStorage
      function saveGanttDataToLocalStorage(data) {
          localStorage.setItem('ganttData', JSON.stringify(data));
      }

      function loadGanttDataFromLocalStorage() {
          const data = localStorage.getItem('ganttData');
          return data ? JSON.parse(data) : null;
      }

      // Example: Hook into your Gantt chart's data change event
      function onGanttDataChanged(newData) {
          saveGanttDataToLocalStorage(newData);
          window.ganttDataUnsaved = true;
      }

      // Load data on page load
      window.addEventListener('DOMContentLoaded', function() {
          const savedData = loadGanttDataFromLocalStorage();
          if (savedData) {
              // Replace with your Gantt chart's data loading logic
              // e.g., gantt.parse(savedData);
          }
          window.ganttDataUnsaved = false;
      });

      let isReloading = false;
      let isModalActive = false;

      window.addEventListener('keydown', function(e) {
          // F5 or Ctrl+R or Cmd+R
          if (
              e.key === 'F5' ||
              (e.ctrlKey && e.key === 'r') ||
              (e.metaKey && e.key === 'r')
          ) {
              isReloading = true;
          }
      });

      let closeAttempted = false;
      window.addEventListener('beforeunload', function (e) {
          if (window.ganttDataUnsaved && !isReloading && !isModalActive) {
              // Show custom modal and prevent close
              closeAttempted = true;
              showExportReminderModal(function(action) {
                  if (action === 'leave') {
                      closeAttempted = false;
                      isModalActive = false;
                      window.ganttDataUnsaved = false;
                      window.removeEventListener('beforeunload', beforeUnloadHandler);
                      window.close();
                  } else if (action === 'export') {
                      // After export, allow close
                      closeAttempted = false;
                      isModalActive = false;
                      window.ganttDataUnsaved = false;
                      window.removeEventListener('beforeunload', beforeUnloadHandler);
                      window.close();
                  } else {
                      closeAttempted = false;
                      isModalActive = false;
                  }
              });
              e.preventDefault();
              e.returnValue = '';
              return '';
          }
      });

      window.addEventListener('unload', function() {
          isReloading = false;
      });

      Vue.component('gantt-chart-list-item', {
        template: "#gantt-chart-list-item",
        props: ['itemName'],
        mounted: function () {
          this.$el.addEventListener("drag", (ev) => { this.$emit('drag', ev); });
          this.$el.addEventListener("dragstart", (ev) => { this.$emit('dragstart', ev); });
          this.$el.addEventListener("dragend", (ev) => { this.$emit('dragend', ev); });
          this.$el.addEventListener("dragover", (ev) => { ev.preventDefault(); this.dragover = true; this.$emit('dragover', ev); });
          this.$el.addEventListener("dragenter", (ev) => { this.$emit('dragenter', ev); });
          this.$el.addEventListener("dragleave", (ev) => { this.dragover = false; this.$emit('dragleave', ev); });
          this.$el.addEventListener("drop", (ev) => { ev.preventDefault(); this.dragover = false; this.$emit('drop', ev); });
        },
        data: function () { 
          return {
            dragover: false
          }; 
        },
        computed: {
          additionalClass: function () { return this.dragover ? ['teal', 'lighten-5'] : [] }
        }
      });

      Vue.component('gantt-chart', {
        template: '#gantt-chart',
        props: ['value'],
        mounted: function () { this.initiate(); },
        computed: {
          colorList: function () {
            if (this.settings.numberOfClass == 'custom') {
              return this.settings.customScheme.map(x => x.color);
            } else {
              return colorbrewer[this.settings.selectedScheme][this.settings.numberOfClass];
            }
          },
          minDate: function () {
            let md = Math.min(...this.getTaskTime(this.tasks, ['planned', 'actual']));
            if (md == Infinity) { return (new Date()).valueOf(); }
            else { return md; }
          },
          maxDate: function () {
            let md = Math.max(...this.getTaskTime(this.tasks, ['planned', 'actual']));
            if (md == -Infinity) { return (new Date()).valueOf() + 100*oneday; }
            else { return md + oneday; }
          },
          colLabels: function () {
            let n = Math.ceil((this.maxDate - this.minDate)/oneday);
            let labels = Array(n).fill(0).map((v,i) => i*oneday + this.minDate);
            let monthLabels = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
            labels = labels.map(v => {
              x = new Date(v);
              return {
                date: x.getDate().toString(),
                month: monthLabels[x.getMonth()],
                year: x.getFullYear().toString()
              }
            });
            let aggregator = (acc, cur) => {
              if ((acc.length > 0) && (cur == acc[acc.length-1].value)) { acc[acc.length - 1].count++; }
              else { acc.push({ value: cur, count: 1 }); }
              return acc;
            }
            labels = [
              labels.map(v => v.year).reduce(aggregator, []),
              labels.map(v => v.month).reduce(aggregator, []),
              labels.map(v => v.date).reduce(aggregator, [])
            ]
            return labels;
          },
          numberOfColumn: function () {
            return this.colLabels[0].reduce((acc, cur) => acc + cur.count, 0);
          },
          taskToDisplay: function () {
            let getTaskToDisplay = (tasks, parent) => {
              let list = tasks.map((task, idx) => {
                let cTaskIdx = parent.concat([idx])
                let subtaskIdx = [];
                if (!task.collapsed) {
                  subtaskIdx = getTaskToDisplay(task.subtasks, cTaskIdx);
                }
                return [cTaskIdx].concat(subtaskIdx);
              });
              return list.reduce((acc, cur) => {
                return acc.concat(cur);
              }, []).filter(val => val.length != 0);
            };
            return getTaskToDisplay(this.tasks, []);
          }
        },
        data: function () {
          return {
            colorbrewer: colorbrewer,
            settings: {
              ganttChartName: "Gantt chart name",
              numberOfClass: 3,
              selectedScheme: 'PuBu',
              customScheme: [],
              rowHeight: 40,
              columnWidth: 28,
              dateDisplay: [0,1,2],
              editMode: true
            },
            tasks: [],
            reorderDialog: false
          }
        },
        methods: {
          initiate: function () {
            this.settings.ganttChartName = this.value.ganttChartName;
            this.settings.numberOfClass = this.value.numberOfClass;
            this.settings.selectedScheme = this.value.selectedScheme;
            this.settings.customScheme = this.value.customScheme;
            this.settings.rowHeight = this.value.rowHeight;
            this.settings.columnWidth = this.value.columnWidth;
            this.settings.dateDisplay = this.value.dateDisplay;
            this.tasks = this.value.tasks;
          },
          addNewTask: function () {
            this.tasks.push({
              name: 'Task ' + (this.tasks.length + 1),
              description: '',
              planned: [],
              actual: [],
              subtasks: [],
              collapsed: true
            });
            this.emitInput();
          },
          getTaskTime: function (tasks, keys) {
            let list = tasks.map((task, ind, arr) => {
              let timeInTask = [];
              keys.forEach(k => {
                timeInTask = timeInTask.concat(task[k]);
              });
              let timeInSubtasks = this.getTaskTime(task.subtasks, keys);
              return timeInTask.concat(timeInSubtasks);
            });
            return list
            .reduce((acc, cur) => {
              return acc.concat(cur);
            }, [])
            .filter((val, ind, arr) => {
              return arr.indexOf(val) == ind;
            })
            .map(val => new Date(val));
          },
          getDatePos: function (taskId, key) {
            let task;
            taskId.forEach((id, i) => {
              if (i == 0) { task = this.tasks[id]; }
              else { task = task.subtasks[id]; }
            });
            let date = (task[key] && task[key][0]) ? task[key][0] : null;
            if (!date) return 0;
            let curDate = (new Date(date).valueOf());
            return (curDate - this.minDate) / (this.maxDate - this.minDate) * (this.settings.columnWidth*this.numberOfColumn);
          },
          getBarWidth: function (taskId, key) {
            let task;
            taskId.forEach((id, i) => {
              if (i == 0) { task = this.tasks[id]; }
              else { task = task.subtasks[id]; }
            });
            let dateRange = task[key];
            if (!dateRange || !dateRange[0] || !dateRange[1]) return 0;
            let curRange = [(new Date(dateRange[0])).valueOf(), (new Date(dateRange[1])).valueOf() + oneday];
            return (curRange[1] - curRange[0]) / (this.maxDate - this.minDate) * (this.settings.columnWidth*this.numberOfColumn);
          },
          getTaskId: function (taskId) {
            return taskId.map(x => x+1).join('.');
          },
          getTaskFromId: function (taskId) {
            let task;
            taskId.forEach((id, i) => {
              if (i == 0) { task = this.tasks[id]; }
              else { task = task.subtasks[id]; }
            });
            return task;
          },
          setTaskFromId: function (taskId, event) {
            let task;
            taskId.forEach((id, i) => {
              if (i == 0) { task = this.tasks[id]; }
              else { task = task.subtasks[id]; }
            });
            task.actual = event.actual;
            task.description = event.description;
            task.name = event.name;
            task.planned = event.planned;
            task.subtasks = event.subtasks;
            this.emitInput();
          },
          removeTaskWithId: function (taskId) {
            let task;
            taskId.forEach((id, i, arr) => {
              if (i == 0) { task = this.tasks; }
              else { task = task.subtasks; }

              if (i == arr.length - 1) { task.splice(id, 1); }
              else { task = task[id] }
            });
            this.emitInput();
          },
          reduceColWidth: function () {
            if (this.settings.columnWidth > 1) {
              let newCW = this.settings.columnWidth - 1;
              if (newCW < 1) { newCW = 1; }
              this.settings.columnWidth = newCW;
            } else { this.settings.columnWidth *= 0.7; }
            this.emitInput();
          },
          increaseColWidth: function () {
            if (this.settings.columnWidth > 1) { this.settings.columnWidth += 1; } 
            else { this.settings.columnWidth /= 0.7; }
            this.emitInput();
          },
          reduceRowHeight: function () {
            if (this.settings.rowHeight > 1) {
              let newCW = this.settings.rowHeight - 1;
              if (newCW < 1) { newCW = 1; }
              this.settings.rowHeight = newCW;
            } else { this.settings.rowHeight *= 0.7; }
            this.emitInput();
          },
          increaseRowHeight: function () {
            if (this.settings.rowHeight > 1) { this.settings.rowHeight += 1; } 
            else { this.settings.rowHeight /= 0.7; }
            this.emitInput();
          },
          emitInput: function () {
            this.$emit('input', {
              ganttChartName: this.settings.ganttChartName,
              numberOfClass: this.settings.numberOfClass,
              selectedScheme: this.settings.selectedScheme,
              customScheme: this.settings.customScheme,
              rowHeight: this.settings.rowHeight,
              columnWidth: this.settings.columnWidth,
              dateDisplay: this.settings.dateDisplay,
              tasks: this.tasks
            });
          },
          startDragTask: function (ev, taskId) { ev.dataTransfer.setData('taskId', JSON.stringify(taskId)); },
          dropTask: function (ev, taskId) { 
            let droppedId = ev.dataTransfer.getData('taskId');
            let thisId = JSON.stringify(taskId);
            if (droppedId != thisId) { this.$emit('reorder-task', [droppedId, thisId]); }
          }
        }
      });

      Vue.component('gantt-settings', {
        template: '#gantt-settings',
        props: ['value'],
        data: function () {
          return {
            colorbrewer: colorbrewer,
            isOpened: false,
            dateDisplay: 0,
            ganttChartName: "",
            numberOfClass: 3,
            selectedScheme: 'PuBu',
            customScheme: [],
            customColorDefault: {
              tab: 0,
              palette: {
                hue: 100,
                n: 60
              },
              color: "#ff6464"
            },
            customPanel: null,
            rowHeight: 40,
            columnWidth: 40,
            editMode: true
          }
        },
        methods: {
          updateValue: function () {
            this.ganttChartName = this.value.ganttChartName;
            this.numberOfClass = this.value.numberOfClass;
            this.selectedScheme = this.value.selectedScheme;
            this.customScheme = this.value.customScheme;
            this.rowHeight = this.value.rowHeight;
            this.columnWidth = this.value.columnWidth;
            this.dateDisplay = this.value.dateDisplay;
            this.editMode = this.value.editMode;
          },
          addNewColor: function (i) {
            if (i == null) { this.customScheme.push(JSON.parse(JSON.stringify(this.customColorDefault))); }
            else { this.customScheme.splice(i, 0, JSON.parse(JSON.stringify(this.customColorDefault))); }
          },
          confirmSettings: function () {
            this.$emit('input', {
              ganttChartName: this.ganttChartName,
              numberOfClass: this.numberOfClass,
              selectedScheme: this.selectedScheme,
              customScheme: this.customScheme,
              rowHeight: this.rowHeight,
              columnWidth: this.columnWidth,
              dateDisplay: this.dateDisplay,
              editMode: this.editMode
            });
          }
        }
      });

      Vue.component('color-chooser', {
        template: '#color-chooser',
        computed: {
          numSep: function () {
            return Math.ceil(this.totalChoice/6);
          },
          sepVal: function () {
            return Math.floor((255 - this.minVal)/this.numSep);
          },
          maxVal: function () {
            return this.sepVal*this.numSep + this.minVal;
          },
          colorPalette: function () {
            return Array(6*this.numSep)
              .fill(0)
              .map((x,i) => {
                let r = 0;
                let g = 0;
                let b = 0;
                if (i <= this.numSep) { r = this.maxVal; }
                else if (i <= 2*this.numSep) { r = this.maxVal - (i - this.numSep)*this.sepVal; }
                else if (i <= 4*this.numSep) { r = this.minVal; }
                else if (i <= 5*this.numSep) { r = this.minVal + (i - 4*this.numSep)*this.sepVal; }
                else { r = this.maxVal; }

                if (i <= this.numSep) { g = this.minVal + i*this.sepVal; }
                else if (i <= 3*this.numSep) { g = this.maxVal; }
                else if (i <= 4*this.numSep) { g = this.maxVal - (i - 3*this.numSep)*this.sepVal; }
                else { g = this.minVal; }

                if (i <= 2*this.numSep) { b = this.minVal; }
                else if (i <= 3*this.numSep) { b = this.minVal + (i - 2*this.numSep)*this.sepVal; }
                else if (i <= 5*this.numSep) { b = this.maxVal; }
                else { b = this.maxVal - (i - 5*this.numSep)*this.sepVal; }

                return '#' + r.toString(16).padStart(2, '0')
                + g.toString(16).padStart(2, '0')
                + b.toString(16).padStart(2, '0');
              });
          },
          greyPalette: function () {
            let gp = [];
            let val = 255;
            let sep = 17;
            gp.push('#' + val.toString(16).padStart(2,0) + val.toString(16).padStart(2,0) + val.toString(16).padStart(2,0));
            do {
              val -= sep;
              gp.push('#' + val.toString(16).padStart(2,0) + val.toString(16).padStart(2,0) + val.toString(16).padStart(2,0));
            } while (val > 0)
            return gp;
          }
        },
        data: function () {
          return {
            colorbrewer: colorbrewer,
            customColorTab: 0,
            minVal: 100,
            totalChoice: 60,
            value: {
              tab: 0,
              palette: {
                hue: 100,
                n: 60
              },
              color: "#000000"
            }
          }
        },
        methods: {
          add: function (x,y) {
            return x + y;
          },
          minus: function (x,y) {
            return x - y;
          },
          selectColor: function (newColor) {
            this.value.color = newColor;
            this.value.tab = this.customColorTab;
            this.value.palette.hue = this.minVal;
            this.value.palette.n = this.totalChoice;
            this.$emit("input", this.value);
            this.$emit("selected", this.value);
          }
        }
      });

      Vue.component('task-title', {
        template: '#task-title',
        props: ['value', 'editMode'],
        mounted: function () {
          this.$el.addEventListener("drag", (ev) => { this.$emit('drag', ev); });
          this.$el.addEventListener("dragstart", (ev) => { this.$emit('dragstart', ev); });
          this.$el.addEventListener("dragend", (ev) => { this.$emit('dragend', ev); });
          this.$el.addEventListener("dragover", (ev) => { ev.preventDefault(); this.dragover = true; this.$emit('dragover', ev); });
          this.$el.addEventListener("dragenter", (ev) => { this.$emit('dragenter', ev); });
          this.$el.addEventListener("dragleave", (ev) => { this.dragover = false; this.$emit('dragleave', ev); });
          this.$el.addEventListener("drop", (ev) => { ev.preventDefault(); this.dragover = false; this.$emit('drop', ev); });
        },
        data: function () {
          return {
            details: {},
            isOpened: false,
            plannedMenu: false,
            actualMenu: false,
            dragover: false
          };
        },
        computed: {
          plannedText: function () {
            if (!this.details.planned || !this.details.planned[0]) return '';
            return this.details.planned[0] + ' ~ ' + this.details.planned[1];
          },
          actualText: function () {
            if (!this.details.actual || !this.details.actual[0]) return '';
            return this.details.actual[0] + ' ~ ' + this.details.actual[1];
          },
          additionalClass: function () { return this.dragover ? ['teal', 'lighten-5'] : [] }
        },
        methods: {
          openDetails: function () { 
            if (this.isOpened == false) {
              this.isOpened = true; 
              this.details = JSON.parse(JSON.stringify(this.value));
            }
          },
          confirmChanges: function () {
            this.$emit('input', this.details);
          },
          addNewSubtask: function () {
            this.details.subtasks.push({
              name: 'Subtask ' + (this.details.subtasks.length + 1),
              description: '',
              planned: [startDay, endDay],
              actual: [startDay, endDay],
              subtasks: [],
              collapsed: true
            });
          },
          removeSubtask: function (i) {
            this.details.subtasks.splice(i,1);
          },
          startDragSubTask: function (ev, taskId) { ev.dataTransfer.setData('taskId', JSON.stringify(taskId)); },
          dropSubTask: function (ev, taskId) { 
            let droppedId = ev.dataTransfer.getData('taskId');
            let thisId = JSON.stringify(taskId);
            // console.log(droppedId, thisId);
            let taskToMove = this.details.subtasks.splice(droppedId,1)[0];
            if (droppedId >= thisId) { this.details.subtasks.splice(thisId,0,taskToMove); }
            else { this.details.subtasks.splice(thisId-1,0,taskToMove); }
          }
        }
      });

      Vue.component('help-dialog', {
        template: '#help-dialog',
        props: { value: Boolean },
        data: function () {
          return {
            content: [
              {
                title: "Import/Export JSON",
                content: "Use the Import JSON and Export JSON buttons to load and save Gantt chart data."
              },
              {
                title: "Planned/actual dates",
                content: "The Gantt charts only show the planned dates. Actual dates are not implemented yet."
              },
              {
                title: "Others",
                content: "For specific enquiry, you may contact me (Richard Wong) at ricwtk[at]gmail.com"
              }
            ]
          }
        },
        methods: {
          changeValue: function (event) { this.$emit('input', event); },
          closeDialog: function () { this.$emit('input', false); },
        }
      });

      var vm = new Vue({
        el: '#app',
        vuetify: new Vuetify({
          theme: {
            themes: {
              light: {
                primary: '#009688',
                secondary: '#B2DFDB',
                accent: '#00BFA5'
              }
            }
          },
        }),
        data: {
          colorbrewer: colorbrewer,
          drawer: true,
          gantts: [],
          notice: "",
          showNotice: false,
          helpDialog: false,
          blockingLoading: false,
          blockingLoadingText: "loading text goes here",
          contentChanged: false,
          currentFile: { name: "" },
          exportReminderDialog: false,
          exportReminderCallback: null
        },
        computed: {
          fileNameForDisplay: function () {
            return "Unsaved file";
          }
        },
        methods: {
          getNewGantt: function () {
            return {
              ganttChartName: 'Gantt Chart ' + (this.gantts.length + 1),
              numberOfClass: 3,
              selectedScheme: 'PuBu',
              customScheme: [],
              rowHeight: 40,
              columnWidth: 40,
              dateDisplay: [0,1,2],
              tasks: []
            };
          },
          addNewGantt: function () {
            this.gantts.push(this.getNewGantt());
            this.saveToLocalStorage();
          },
          newInOld: function () {
            window.location.search = "";
          },
          newInNew: function () {
            window.open("./", "_blank");
          },
          newNotice: function (notice) {
            this.notice = notice;
            this.showNotice = true;
            setTimeout(() => { this.showNotice = false; }, 3000);
          },
          importJSON: function () {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
              const file = e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = function(evt) {
                try {
                  const data = JSON.parse(evt.target.result);
                  vm.loadGanttChartData(data);
                  vm.saveToLocalStorage();
                } catch (err) {
                  alert('Invalid JSON file.');
                }
              };
              reader.readAsText(file);
            };
            input.click();
          },
          exportJSON: function () {
            const data = this.getGanttChartData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt-chart-data.json';
            a.click();
            URL.revokeObjectURL(url);
            window.ganttDataUnsaved = false;
          },
          loadGanttChartData: function (data) {
            this.gantts.splice(0, this.gantts.length);
            this.$nextTick(() => { 
              this.gantts.push(...data); 
              this.$nextTick(() => { this.contentChanged = false; });
            });
            this.saveToLocalStorage();
          },
          getGanttChartData: function () {
            return this.gantts;
          },
          openPrivacyPolicy: function () {
            window.open("./privacypolicy.html", "_blank");
          },
          updateHash: function (i) {
            location.hash = "gc" + i;
          },
          reorderTask: function (taskIds, gci) {
            let taskIdToMove = JSON.parse(taskIds[0]);
            let taskIdToPrepend = JSON.parse(taskIds[1]);
            console.log(gci, taskIdToMove, taskIdToPrepend);
            let taskToMove;
            taskIdToMove.forEach((id,i,arr) => {
              if (i == 0) { 
                if (i == arr.length - 1) { taskToMove = this.gantts[gci].tasks.splice(id,1); } 
                else { taskToMove = this.gantts[gci].tasks[id]; }
              } else { 
                if (i == arr.length - 1) { taskToMove = taskToMove.subtasks.splice(id,1); } 
                else { taskToMove = taskToMove.subtasks[id]; }
              }
            });
            taskToMove = taskToMove[0];
            console.log(taskToMove);
            
            let getParentOfTaskToPrepend = (taskIdOfParent) => {
              let parentOfTask;
              if (taskIdOfParent.length > 0) {
                taskIdOfParent.forEach((id,i) => {
                  if (i == 0) { parentOfTask = this.gantts[gci].tasks[id]; }
                  else { parentOfTask = parentOfTask.subtasks[id]; }
                });
                parentOfTask = parentOfTask.subtasks;
              } else { parentOfTask = this.gantts[gci].tasks; }
              return parentOfTask;
            };

            let movel = taskIdToMove.length;
            let prepl = taskIdToPrepend.length;
            if (movel == prepl) {
              let parentOfTaskToPrepend = getParentOfTaskToPrepend(taskIdToPrepend.slice(0,-1));
              if (JSON.stringify(taskIdToMove.slice(0,-1)) == JSON.stringify(taskIdToPrepend.slice(0,-1))) {
                if (taskIdToMove[movel - 1] > taskIdToPrepend[prepl - 1]) { parentOfTaskToPrepend.splice(taskIdToPrepend[prepl - 1], 0, taskToMove); } 
                else { parentOfTaskToPrepend.splice(taskIdToPrepend[prepl - 1]-1, 0, taskToMove); }
              } else { parentOfTaskToPrepend.splice(taskIdToPrepend[prepl - 1], 0, taskToMove); }
            } else if (movel < prepl) {
              if (JSON.stringify(taskIdToMove.slice(0,-1) == JSON.stringify(taskIdToPrepend.slice(0,movel-1)))) {
                if (taskIdToMove[movel - 1] > taskIdToPrepend[movel - 1]) { 
                  let parentOfTaskToPrepend = getParentOfTaskToPrepend(taskIdToPrepend.slice(0,-1));
                  parentOfTaskToPrepend.splice(taskIdToPrepend[prepl - 1], 0, taskToMove); 
                } else if (taskIdToMove[movel - 1] < taskIdToPrepend[movel - 1]) {
                  taskIdToPrepend[movel - 1] -= 1;
                  let parentOfTaskToPrepend = getParentOfTaskToPrepend(taskIdToPrepend.slice(0,-1));
                  parentOfTaskToPrepend.splice(taskIdToPrepend[prepl - 1], 0, taskToMove); 
                } else { // taskIdToMove[movel - 1] == taskIdToPrepend[movel - 1]
                  let parentOfTaskToPrepend = getParentOfTaskToPrepend(taskIdToMove.slice(0,-1));
                  parentOfTaskToPrepend.splice(taskIdToMove[movel - 1], 0, taskToMove);
                }
              }
            } else { // movel > prepl
              let parentOfTaskToPrepend = getParentOfTaskToPrepend(taskIdToPrepend.slice(0,-1));
              parentOfTaskToPrepend.splice(taskIdToPrepend[prepl - 1], 0, taskToMove); 
            }
            this.saveToLocalStorage();
          },
          removeGantt: function (gci) {
            this.gantts.splice(gci, 1);
            this.updateGantts();
            this.saveToLocalStorage();
          },
          updateGantts: function () {
            this.$nextTick(() => {
              this.$refs.gc.forEach(g => g.initiate());
            });
          },
          openSite: function (site) {
            window.open(site, "_blank");
          },
          startDragGanttListItem: function (ev, ganttId) { ev.dataTransfer.setData('ganttId', JSON.stringify(ganttId)); },
          dropGanttListItem: function (ev, ganttId) { 
            let droppedId = ev.dataTransfer.getData('ganttId');
            let thisId = JSON.stringify(ganttId);
            // console.log(droppedId, thisId);
            let ganttToMove = this.gantts.splice(droppedId,1)[0];
            if (droppedId >= thisId) { this.gantts.splice(thisId,0,ganttToMove); }
            else { this.gantts.splice(thisId-1,0,ganttToMove); }
            this.updateGantts();
            this.saveToLocalStorage();
          },
          saveToLocalStorage: function () {
            saveGanttDataToLocalStorage(this.gantts);
            window.ganttDataUnsaved = true;
          },
          showExportReminderModal: function(callback) {
            this.exportReminderCallback = callback;
            this.exportReminderDialog = true;
          },
          handleExportReminder: function(action) {
            this.exportReminderDialog = false;
            if (this.exportReminderCallback) this.exportReminderCallback(action);
          },
          scrollToGantt: function(i) {
            this.$nextTick(() => {
              const el = document.getElementById('gc' + i);
              if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
              }
            });
          }
        },
        watch: {
          gantts: {
            handler: function () {
              this.saveToLocalStorage();
            },
            deep: true
          }
        },
        created: function () {
          const savedData = loadGanttDataFromLocalStorage();
          if (savedData) {
            this.gantts = savedData;
          } else {
            this.gantts = [];
            this.addNewGantt();
          }
        }
      });

      window.showExportReminderModal = function(callback) {
        if (window.vm && window.vm.showExportReminderModal) {
          window.vm.showExportReminderModal(callback);
        }
      };
    </script>
  </body>
</html>
